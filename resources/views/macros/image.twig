{% macro image_thumbnail(thumbnail, size) %}
  {# Specify the dimensions manually so we can upscale #}
  {% set dimensions = get_image_size(size) %}

  {% import _self as image %}
  {{ image.image(thumbnail, [dimensions.width, dimensions.height], dimensions.crop) }}
{% endmacro %}

{# Output an image tag #}
{% macro image(thumbnail, dimensions, crop, is_retina, is_smartcrop) %}
  {% import _self as image %}

  {% set thumbnail = (not thumbnail.src) ? TimberImage(thumbnail) : thumbnail %}

  {% if thumbnail.src %}
    {% set img          = thumbnail.src|tojpg %}
    {% set width        = dimensions[0] %}
    {% set height       = dimensions[1] %}
    {% set is_crop      = crop      is not null ? crop      : global_img_crop %}
    {% set is_retina    = retina    is not null ? retina    : global_img_retina %}
    {% set is_smartcrop = smartcrop is not null ? smartcrop : ((thumbnail._wpsmartcrop_enabled) and (width) and (height)) %}
    {% set is_lazyload  = lazyload  is not null ? lazyload  : global_img_lazyload %}

    {# Smarcrop plugin support #}
    {% if (is_smartcrop) %}
      {% set img_1x = img|resize(width) %}
      {% set img_2x = img_1x %}
    {# User defined a size #}
    {% elseif (width or height) %}
      {% set img_1x = img|resize(width, height, is_crop) %}

      {# Serve retina image. #}
      {% if (is_retina) %}
        {% set img_2x = img|resize(width ? (width * 2), height ? (height * 2), is_crop) %}
      {% endif %}
    {# Output image as is. #}
    {% else %}
      {% set img_1x = img %}
    {% endif %}

    {% if (is_smartcrop and is_crop) %}
      <div class="smartcrop__container" style="width: 100%; height: 0; padding-bottom:{{ (height/width) * 100 }}%;">
    {% endif %}

    {{image.tag(thumbnail, {
      'width': width,
      'height': height,
      'smartcrop': is_smartcrop,
      'lazyload': is_lazyload,
      'src': img_1x,
      'srcset': is_retina ? (img_1x ~ ' 1x, ' ~ img_2x ~ ' 2x') : false
    })}}

    {% if is_smartcrop %}</div>{% endif %}
  {# Prevent those annoying OOM and MySQL crashes when the source doesn't exist. #}
  {% else %}
    <img data-twig-error="no image source attribute" />
  {% endif %}
{% endmacro %}

{# Print an image tag #}
{% macro tag(thumbnail, options) %}
  {% import _self as image %}
  <img
    alt="{{options.alt|default(thumbnail._wp_attachment_image_alt)|default(thumbnail.title)|default(wp_title)}}"
    title="{{options.title|default(thumbnail.title)}}"
    class="{{options.smartcrop ? 'smartcrop '}}{{options.lazyload ? 'lazyload '}}{{options.class}}"
    {% if options.width %}width="{{options.width}}"{% endif %}
    {% if options.height %}height="{{options.height}}"{% endif %}
    {# Lazyload #}
    {% if options.lazyload %}
      src="{{options.placeholder?:'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='}}"
      {# Retina takes priority #}
      {% if options.srcset %}
        data-srcset="{{options.srcset}}"
      {# Regular non-retina #}
      {% elseif options.src %}
        data-src="{{options.src}}"
      {% endif %}
    {# Regular, not lazyloaded #}
    {% else %}
      {% if options.srcset %}
        srcset="{{options.srcset}}"
      {% elseif options.src %}
        src="{{options.src}}"
      {% endif %}
    {% endif %}
    {# Smartcrop #}
    {% if options.smartcrop %}
      {% set focus = fn('unserialize', thumbnail._wpsmartcrop_image_focus) %}
      style="object-position: {{focus.left|round(2)}}% {{focus.top|round(2)}}%;"
    {% endif %}
  />
  {% if options.lazyload %}
    <noscript>{{image.tag(thumbnail, options|merge({'lazyload': false}))}}</noscript>
  {% endif %}
{% endmacro %}

{% macro placeholder(dimensions) %}
  {% set width = dimensions[0]|default(400) %}
  {% set height = dimensions[1]|default(width / 1.5)|round %}

  {% spaceless %}
    <img
      width="{{width}}"
      height="{{height}}"
      srcset="
        https://unsplash.it/{{width}}/{{height}}?random 1x,
        https://unsplash.it/{{width*2}}/{{height*2}}?random 2x
      "
    >
  {% endspaceless %}
{% endmacro %}
