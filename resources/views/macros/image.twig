{% macro image_thumbnail(thumbnail, size) %}
  {# Specify the dimensions manually so we can upscale #}
  {% set dimensions = get_image_size(size) %}

  {% import _self as image %}
  {{ image.image(thumbnail, [dimensions.width, dimensions.height], dimensions.crop) }}
{% endmacro %}

{# Output an image tag #}
{% macro image(thumbnail, dimensions, crop, is_retina, is_smartcrop) %}
  {% import _self as image %}

  {% set thumbnail = (not thumbnail.src) ? TimberImage(thumbnail) : thumbnail %}

  {% if thumbnail.src %}
    {% set img = thumbnail.src|tojpg %}
    {% set width = dimensions[0] %}
    {% set height = dimensions[1] %}
    {% set is_retina = is_retina|default(true) %}
    {% set is_smartcrop = is_smartcrop|default(thumbnail._wpsmartcrop_enabled and width and height) %}

    {# Smarcrop plugin support #}
    {% if (is_smartcrop) %}
      {% set img_1x = img|resize(width) %}
      {% set img_2x = img_1x %}
    {# User defined a size #}
    {% elseif (width or height) %}
      {% set img_1x = img|resize(width, height, crop) %}

      {# Serve retina image. #}
      {% if (is_retina) %}
        {% set img_2x = img|resize(width ? (width * 2), height ? (height * 2), crop) %}
      {% endif %}
    {# Output image as is. #}
    {% else %}
      {% set img_1x = img %}
    {% endif %}

    {% if (is_smartcrop and crop|default(true)) %}
      <div class="smartcrop__container" style="width: 100%; height: 0; padding-bottom:{{ (height/width) * 100 }}%;">
    {% endif %}

    <img
      alt="{{thumbnail._wp_attachment_image_alt|default(thumbnail.title)|default(wp_title)}}"
      title="{{thumbnail.title}}"
      {% if width %}width="{{width}}"{% endif %}
      {% if height %}height="{{height}}"{% endif %}

      {# Focus point cropping #}
      {% if is_smartcrop %}{{image.smartcrop_attributes(thumbnail)}}{% endif %}

      {# Retina image #}
      {% if is_retina %}
        srcset="
          {# @see https://github.com/timber/timber/issues/404 #}
          {{img_1x}},
          {{img_2x}} 2x
        "
      {% else %}
        src="{{img_1x}}"
      {% endif %}
    />

    {% if is_smartcrop %}</div>{% endif %}
  {# Prevent those annoying OOM and MySQL crashes when the source doesn't exist. #}
  {% else %}
    <img data-twig-error="no image source attribute" />
  {% endif %}
{% endmacro %}

{# Add necessary smartcrop attribtues to an <img>-element. #}
{% macro smartcrop_attributes(image) %}
  {% if image._wpsmartcrop_enabled %}
    {% set focus = fn('unserialize', image._wpsmartcrop_image_focus) %}
    class="smartcrop"
    style="object-position: {{focus.left|round(2)}}% {{focus.top|round(2)}}%;"
  {% endif %}
{% endmacro %}

{% macro placeholder(dimensions) %}
  {% set width = dimensions[0]|default(400) %}
  {% set height = dimensions[1]|default(width / 1.5)|round %}

  {% spaceless %}
    <img
      width="{{width}}"
      height="{{height}}"
      srcset="
        https://unsplash.it/{{width}}/{{height}}?random 1x,
        https://unsplash.it/{{width*2}}/{{height*2}}?random 2x
      "
    >
  {% endspaceless %}
{% endmacro %}
